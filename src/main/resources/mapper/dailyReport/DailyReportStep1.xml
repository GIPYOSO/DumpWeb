<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.dispatch.dump.commonModule.db.mapper.DailyReportStep1Mapper">


    <sql id="res_table">
        WITH r1 AS
            (
                SELECT *
                FROM tsheet
                WHERE sheetSS = #{uuserID}
                  AND date BETWEEN ${startDate} AND ${endDate}
            ),
            r2 AS
           (
        SELECT *
        FROM tsheet_sub
            ),
            r3 AS
            (
        SELECT *
        FROM r1
            INNER JOIN r2 ON r1.sheetID = r2.sheetID2
            ),
            tdrive_table AS -- 가상 테이블로 tdrive 테이블을 추가합니다.
            (
        SELECT drvDate, useAmt
        FROM tdrive
        WHERE drvDate BETWEEN ${startDate} AND ${endDate} -- startDate와 endDate 사이의 drvDate를 조회합니다.
          AND driveSS = #{uuserID}
            )
    </sql>

    <select id="selectCalTotal" parameterType="DailyReportStep1Option" resultType="DailyReportStep1Total">
        <include refid="res_table">
            <property name="uuserID" value="#{uuserID}"/>
            <property name="startDate" value="#{option.startDate}"/>
            <property name="endDate" value="#{option.endDate}"/>
        </include>

        SELECT
        IF(SUM(Qty * Qtyup) IS NULL, 0, SUM(Qty * Qtyup)) AS 'totalTransportationCost',
        IF(SUM(Qty) IS NULL, 0, SUM(Qty)) AS 'totalTrips',
        (
        SELECT MAX(drvDate) -- tdrive_table에서 drvDate의 최대값을 조회합니다.
        FROM tdrive_table
        ) AS 'finalDrvDate',
        (
        SELECT IF(SUM(useAmt) IS NULL, 0, SUM(useAmt)) -- tdrive_table의 useAmt의 합계를 조회합니다.
        FROM tdrive_table
        ) AS 'totalUseAmt'
        FROM tSheet_sub
        WHERE sheetID2 IN (SELECT sheetid2 FROM r3)
    </select>


    <select id="selectDispatchSubmitList" resultType="DailyReportStep1Sub">
        <include refid="res_table">
            <property name="uuserID" value="#{uuserID}"/>
            <property name="startDate" value="#{today}"/>
            <property name="endDate" value="#{today}"/>
        </include>
        select * from r3



    </select>

    <select id="selectDispatchTdriveList" resultType="DailyReportStep1Tdrive">
        SELECT rependchk,
               driveSS,
               carNo,
               IF(rependdate IS NULL, '1999-01-01',rependdate) AS 'rependdate',
                repaddkm,
               drvClub
        FROM   tDrive
        where carNo = #{carNo} AND rependchk = false


    </select>






    




</mapper>